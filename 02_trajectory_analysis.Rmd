---
title: "Trajectory Analysis"
author:
  - name: Brian Peña-Calero
    email: brian.pena@upch.pe
    affiliation: Innovar, UPCH
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
    toc_depth: 3
    toc_float: yes
    number_sections: yes
    code_folding: show
    code_download: yes
    theme: 
      bootswatch: flatly
    highlight: kate
    highlight_downlit: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  dpi = 300,
  fig.align = 'center'
  # message = FALSE,
  # warning = FALSE,
  # error = TRUE
)
```

# Load packages

```{r}
library(tidyverse)
library(gbmt)
```



# Import data

```{r}
pop_bectuareal <- readRDS("01_data/processed/pop_bectuareal.rds")
```


# Analysis

```{r}
pop_bectuareal <- pop_bectuareal %>% 
  filter(YEAR >= 1985) %>% 
  as.data.frame()
```


```{r}
pop_bectuareal_gbmt <- gbmt(
  x.names = c("Population", "BECTUAREAL1AD"), 
  unit = "SALID1", 
  time = "YEAR", 
  d = 2, ng = 4, 
  data = as.data.frame(pop_bectuareal), 
  scaling = 4
)
```

```{r}
summary(pop_bectuareal_gbmt)
```

Se identificaron cuatro grupos diferentes en el análisis de trayectorias. Cada grupo tiene diferentes características de cambio a lo largo del tiempo en las variables de respuesta "Population" y "BECTUAREAL1AD". Los coeficientes de los términos de tiempo lineal (I(t^1)) y cuadrático (I(t^2)) describen cómo cambian las variables de respuesta a lo largo del tiempo para cada grupo.

Grupo 1: Este grupo tiene 202 unidades y un APPA (Average Posterior Probability of Assignment) de 0.9681, lo que indica una alta probabilidad de que las unidades pertenezcan a este grupo. La población en este grupo disminuye en general a lo largo del tiempo (coeficiente negativo para I(t^1)), pero a una tasa decreciente (coeficiente negativo para I(t^2)). La variable BECTUAREAL1AD también disminuye a lo largo del tiempo, pero a una tasa decreciente.

Grupo 2: Este grupo tiene 47 unidades y un APPA de 0.8137. La población en este grupo se mantiene relativamente constante a lo largo del tiempo, con un coeficiente muy pequeño para I(t^1) y ningún cambio en la tasa de crecimiento (I(t^2) igual a 0). La variable BECTUAREAL1AD disminuye a lo largo del tiempo, pero a una tasa decreciente.

Grupo 3: Este grupo tiene 319 unidades y un APPA de 0.9717, lo que indica una alta probabilidad de que las unidades pertenezcan a este grupo. La población en este grupo disminuye a lo largo del tiempo, pero a una tasa decreciente. La variable BECTUAREAL1AD también disminuye a lo largo del tiempo, pero a una tasa decreciente.

Grupo 4: Este grupo tiene 80 unidades y un APPA de 0.9596, lo que indica una alta probabilidad de que las unidades pertenezcan a este grupo. La población en este grupo disminuye a lo largo del tiempo, pero a una tasa decreciente. La variable BECTUAREAL1AD disminuye a lo largo del tiempo, pero a una tasa decreciente.



```{r}
predicted_means <- predict(pop_bectuareal_gbmt)

predicted_means_f <- map(predicted_means,
    ~ map(., ~ as_tibble(., rownames = "Year"))) %>% 
  bind_rows(.id = "Cluster") %>% 
  unpack(c(Population, BECTUAREAL1AD),
         names_sep = "_") %>% 
  mutate(
    across(c(Population_Year, BECTUAREAL1AD_Year),
           as.numeric)
  ) %>% 
  pivot_longer(
    cols = -Cluster,
    names_to = c("Variable", "Statistic"),
    names_sep = "_"
  ) %>% 
  pivot_wider(
    names_from = Statistic,
    values_from = value,
    values_fn = list
  ) %>% 
  unnest()
```

```{r}
plot_predicted_means_f <- predicted_means_f %>% 
  ggplot(
    aes(
      x = Year,
      y = mean,
      group = Cluster,
      color = Cluster
    )
  ) +
  geom_line(size = 2) +
  geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`), alpha = 0.05) +
  scale_x_continuous(
    breaks = seq(1985, 2015, 5)
  ) +
  facet_wrap(vars(Variable)) +
  theme_minimal()


ggsave("02_output/plots/predicted_means_f.png",
       plot_predicted_means_f,
       dpi = 400,
       bg = "white")

plot(pop_bectuareal_gbmt)
coef(pop_bectuareal_gbmt)
```


```{r}
plot_predicted_means_f2 <- predicted_means_f %>% 
  ggplot(
    aes(
      x = Year,
      y = mean,
      group = Cluster,
      color = Cluster
    )
  ) +
  geom_line(size = 2) +
  #geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`), alpha = 0.05) +
  scale_x_continuous(
    breaks = seq(1985, 2015, 5)
  ) +
  facet_wrap(vars(Variable)) +
  theme_minimal()


ggsave("02_output/plots/predicted_means_f2.png",
       plot_predicted_means_f2,
       dpi = 400,
       bg = "white")
```








